<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë„¤ì´ë²„ ê²€ìƒ‰ëŸ‰ ëŒ€ëŸ‰ ì¡°íšŒê¸° (ìµœì í™” ë²„ì „)</title>
    <!-- XLSX ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        /* ì‹œê°„ëŒ€ë³„ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
        .time-message {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.98);
            padding: 30px 35px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            z-index: 10001;
            display: none;
            max-width: 350px;
            animation: slideIn 0.5s ease;
        }
        
        .time-message.active {
            display: block;
        }
        
        .time-message .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #999;
            background: none;
            border: none;
            padding: 5px;
            transition: all 0.3s ease;
        }
        
        .time-message .close-btn:hover {
            color: #333;
            transform: scale(1.1);
        }
        
        .time-message h3 {
            margin: 0 0 15px 0;
            font-size: 21px;
            line-height: 1.4;
            text-align: center;
        }
        
        .time-message p {
            font-size: 17px;
            line-height: 1.8;
            margin: 0;
            color: #555;
            text-align: center;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .version {
            text-align: center;
            color: #888;
            font-size: 0.9em;
            margin-bottom: 20px;
        }
        
        /* API ì„¤ì • ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 1.5em;
            color: #2c3e50;
        }
        
        .close-btn {
            font-size: 28px;
            cursor: pointer;
            color: #999;
            border: none;
            background: none;
        }
        
        .api-config-section {
            margin-bottom: 25px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        
        .api-config-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .api-config-title {
            font-weight: 600;
            color: #555;
        }
        
        .api-remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
        }
        
        .api-config-grid {
            display: grid;
            gap: 15px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            margin-bottom: 5px;
            font-size: 0.9em;
            color: #666;
            font-weight: 500;
        }
        
        .form-group input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn {
            padding: 10px 20px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: linear-gradient(45deg, #6c757d, #5a6268);
        }
        
        .btn-success {
            background: linear-gradient(45deg, #28a745, #20c997);
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #dc3545, #c82333);
        }
        
        .btn-warning {
            background: linear-gradient(45deg, #ffc107, #ff9800);
        }
        
        .btn-info {
            background: linear-gradient(45deg, #17a2b8, #138496);
        }
        
        .settings-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1em;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 999;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .settings-btn:hover {
            transform: scale(1.05);
        }
        
        .file-input-wrapper {
            position: relative;
            display: inline-block;
        }
        
        .file-input {
            display: none;
        }
        
        .file-label {
            display: inline-block;
            padding: 10px 20px;
            background: linear-gradient(45deg, #17a2b8, #138496);
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .file-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
        }
        
        .chips {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .chip {
            padding: 6px 16px;
            background: #f0f0f0;
            border-radius: 20px;
            font-size: 0.85em;
            color: #555;
        }
        
        .chip.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .api-status-panel {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .api-status-title {
            font-size: 1.1em;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .api-indicators {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            min-height: 40px; /* ìµœì†Œ ë†’ì´ ê³ ì • */
        }
        
        .api-indicator {
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.3s ease; /* ë¶€ë“œëŸ¬ìš´ ìƒ‰ìƒ ì „í™˜ */
        }
        
        .api-indicator.active {
            background: rgba(76, 175, 80, 0.8);
            font-weight: 600;
        }
        
        .api-indicator.active span:first-child {
            animation: blink 0.5s;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        .api-indicator.inactive {
            background: rgba(255, 255, 255, 0.1);
            opacity: 0.6;
        }
        
        .input-section {
            background: #f9f9f9;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        textarea {
            width: 100%;
            height: 150px;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 12px;
            font-size: 14px;
            resize: vertical;
        }
        
        textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .virtual-scroll-container {
            height: 600px;
            overflow-y: auto;
            margin-top: 20px;
            border-radius: 10px;
            background: #fff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            position: relative;
        }
        
        /* ê°œì„ ëœ í…Œì´ë¸” í—¤ë” ìŠ¤íƒ€ì¼ - ì—¬ëŸ¬ ì¤„ ì§€ì› */
        .table-header {
            position: sticky;
            top: 0;
            z-index: 10;
            background: #1a1a2e;
            color: #fff;
            display: grid;
            grid-template-columns: 2fr 0.8fr 0.8fr 0.8fr 0.8fr 0.8fr 0.6fr 0.6fr 0.8fr 0.8fr 0.6fr 1fr;
            padding: 10px;
            font-weight: 600;
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            border-bottom: 3px solid #16213e;
        }
        
        /* í—¤ë” ì…€ ìŠ¤íƒ€ì¼ - ì—¬ëŸ¬ ì¤„ í—ˆìš© ë° ì¤‘ì•™ ì •ë ¬ */
        .header-cell {
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 5px;
            word-break: keep-all;
            line-height: 1.2;
            min-height: 40px;
        }
        
        /* í…Œì´ë¸” í–‰ ìŠ¤íƒ€ì¼ - ëª¨ë“  ë‚´ìš© ì¤‘ì•™ ì •ë ¬ */
        .table-row {
            display: grid;
            grid-template-columns: 2fr 0.8fr 0.8fr 0.8fr 0.8fr 0.8fr 0.6fr 0.6fr 0.8fr 0.8fr 0.6fr 1fr;
            padding: 10px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 0.9em;
            color: #333;
            background: white;
            transition: background 0.2s;
        }
        
        .table-row:hover {
            background: #f8f9fc;
        }
        
        .table-row.cached {
            background: linear-gradient(90deg, #e8f5e9 0%, white 100%);
        }
        
        /* í…Œì´ë¸” ì…€ - ëª¨ë“  ì…€ ì¤‘ì•™ ì •ë ¬ */
        .table-cell {
            padding: 0 5px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        
        /* í‚¤ì›Œë“œ ì…€ë§Œ ì¢Œì¸¡ ì •ë ¬ */
        .table-cell.keyword {
            justify-content: flex-start;
            text-align: left;
        }
        
        .alert {
            padding: 12px 20px;
            border-radius: 6px;
            margin-bottom: 15px;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .tip {
            text-align: center;
            margin-top: 20px;
            font-size: 0.9em;
            color: #6c757d;
            background: #e7f3ff;
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid #0066cc;
        }
        
        progress {
            width: 200px;
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
        }
        
        progress::-webkit-progress-bar {
            background: #f0f0f0;
        }
        
        progress::-webkit-progress-value {
            background: linear-gradient(45deg, #667eea, #764ba2);
        }
        
        .loading-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ë°°ì¹˜ ì²˜ë¦¬ ìƒíƒœ í‘œì‹œ */
        .batch-status {
            display: inline-block;
            margin-left: 15px;
            padding: 5px 12px;
            background: #e3f2fd;
            border-radius: 15px;
            font-size: 0.9em;
            color: #1976d2;
            font-weight: 600;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        
        .table-row.cached {
            background-color: rgba(40, 167, 69, 0.03);
        }
        
        .table-row.error-row {
            background-color: rgba(220, 53, 69, 0.05);
        }
        
        .api-cell span {
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            display: inline-block;
        }
    </style>
</head>
<body>
    <!-- ì„¤ì • ë²„íŠ¼ -->
    <button class="settings-btn" onclick="openApiModal()">
        âš™ï¸ API ì„¤ì •
    </button>

    <div class="container">
        <h1>ğŸ” ë„¤ì´ë²„ ê²€ìƒ‰ëŸ‰ ëŒ€ëŸ‰ ì¡°íšŒê¸°</h1>
        <p class="version">ìµœì í™” ë²„ì „ v3.0 - ë°°ì¹˜ ì²˜ë¦¬ & ì¤‘ì•™ ì •ë ¬</p>
        
        <div class="chips">
            <span class="chip active">ğŸ”€ ë©€í‹° API</span>
            <span class="chip active">ğŸ’¾ ë¡œì»¬ ì €ì¥</span>
            <span class="chip active">ğŸ“‚ íŒŒì¼ ê°€ì ¸ì˜¤ê¸°/ë‚´ë³´ë‚´ê¸°</span>
            <span class="chip active" id="cacheChip">ğŸš€ IndexedDB ìºì‹œ</span>
            <span class="chip active">ğŸ“¦ ë°°ì¹˜ ì²˜ë¦¬</span>
        </div>
        
        <!-- API ìƒíƒœ íŒ¨ë„ -->
        <div class="api-status-panel">
            <div class="api-status-title">ğŸ“¡ API ìƒíƒœ ëª¨ë‹ˆí„°</div>
            <div class="api-indicators" id="apiIndicators">
                <div class="api-indicator inactive">
                    <span>ì„¤ì •ëœ APIê°€ ì—†ìŠµë‹ˆë‹¤. ìš°ì¸¡ ìƒë‹¨ì˜ ì„¤ì • ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</span>
                </div>
            </div>
        </div>
        
        <!-- ì•Œë¦¼ ì˜ì—­ -->
        <div id="alertArea"></div>
        
        <div class="input-section">
            <div class="input-group">
                <label>ğŸ·ï¸ í‚¤ì›Œë“œ (ì¤„ë°”ê¿ˆ ë˜ëŠ” ì‰¼í‘œë¡œ êµ¬ë¶„) <span style="color: #e74c3c; font-size: 0.9em;">â€» ë„ì–´ì“°ê¸°ëŠ” ìë™ ì œê±°ë©ë‹ˆë‹¤</span></label>
                <textarea id="kw" placeholder="ì˜ˆì‹œ:&#10;ê²Œì´ë° ëª¨ë‹ˆí„° â†’ ê²Œì´ë°ëª¨ë‹ˆí„°&#10;ì„œìš¸ ë§›ì§‘ â†’ ì„œìš¸ë§›ì§‘&#10;ìš´ë™í™”, ë“±ì‚°í™”, ì£¼ì‹ íˆ¬ì â†’ ìš´ë™í™”, ë“±ì‚°í™”, ì£¼ì‹íˆ¬ì"></textarea>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin: 20px 0;">
                <div class="form-group">
                    <label>â±ï¸ ìš”ì²­ ê°„ê²©(ms) - ë‚®ì„ìˆ˜ë¡ ë¹ ë¥´ì§€ë§Œ ì•ˆì •ì„± ì €í•˜</label>
                    <input id="interval" type="number" min="50" step="50" value="100">
                    <small style="color: #666; margin-top: 5px;">ê¶Œì¥: 100-200ms</small>
                </div>
                <div class="form-group">
                    <label>ğŸ“¦ ë°°ì¹˜ í¬ê¸° (ë™ì‹œ ì²˜ë¦¬ í‚¤ì›Œë“œ ìˆ˜)</label>
                    <input id="batchSize" type="number" min="1" max="30" value="3">
                    <small style="color: #666; margin-top: 5px;">ìë™ ê¶Œì¥ê°’: API ê°œìˆ˜ì˜ 70% (í˜„ì¬ APIê°€ ì„¤ì •ë˜ë©´ ìë™ ê³„ì‚°)</small>
                </div>
                <div class="form-group">
                    <label>ğŸ”„ ì¬ì‹œë„ íšŸìˆ˜ (ì—ëŸ¬ ì‹œ ë‹¤ë¥¸ APIë¡œ ì¬ì‹œë„)</label>
                    <input id="retryCount" type="number" min="0" max="20" value="3">
                    <small style="color: #666; margin-top: 5px;">ê¶Œì¥: 3-5íšŒ (ê° APIë¥¼ ìˆœí™˜í•˜ë©° ì¬ì‹œë„)</small>
                </div>
            </div>
            
            <div class="alert alert-warning">
                ğŸ’¡ <strong>ë°°ì¹˜ ì²˜ë¦¬ë€?</strong> ì—¬ëŸ¬ í‚¤ì›Œë“œë¥¼ ë™ì‹œì— ì²˜ë¦¬í•˜ì—¬ ì†ë„ë¥¼ í–¥ìƒì‹œí‚µë‹ˆë‹¤.
                ì˜ˆ: ë°°ì¹˜ í¬ê¸° 3 = 3ê°œ í‚¤ì›Œë“œë¥¼ ë™ì‹œì— API í˜¸ì¶œ
            </div>
            
            <div style="display: flex; align-items: center; gap: 20px; margin: 15px 0;">
                <label>
                    <input type="checkbox" id="useCache" checked>
                    <span>ìºì‹œ ì‚¬ìš© (IndexedDB)</span>
                </label>
                <button class="btn btn-danger" onclick="clearCache()">ìºì‹œ ì´ˆê¸°í™”</button>
                <span id="cacheInfo" style="color: #666;">ìºì‹œ: ê³„ì‚° ì¤‘...</span>
            </div>
            
            <div class="btn-group">
                <button class="btn" id="runBtn" onclick="runSearch()">ğŸ” ì¡°íšŒí•˜ê¸°</button>
                <button class="btn btn-success" id="csvBtn" disabled onclick="downloadCSV()">ğŸ“„ CSV ë‹¤ìš´ë¡œë“œ</button>
                <button class="btn btn-success" id="xlsxBtn" disabled onclick="downloadExcel()">ğŸ“Š Excel ë‹¤ìš´ë¡œë“œ</button>
                <span id="status" style="margin-left: 15px; color: #666;"></span>
                <span id="batchStatus" class="batch-status" style="display:none"></span>
                <span id="loadingIndicator" class="loading-indicator" style="display:none"></span>
                <progress id="prog" max="100" value="0" style="display:none"></progress>
            </div>
        </div>
        
        <!-- ê°€ìƒ ìŠ¤í¬ë¡¤ ì»¨í…Œì´ë„ˆ - ê°œì„ ëœ í—¤ë” -->
        <div class="virtual-scroll-container" id="scrollContainer" style="display:none">
            <div class="table-header">
                <div class="header-cell">í‚¤ì›Œë“œ</div>
                <div class="header-cell">ì´<br>ê²€ìƒ‰ìˆ˜</div>
                <div class="header-cell">PC<br>ê²€ìƒ‰ìˆ˜</div>
                <div class="header-cell">ëª¨ë°”ì¼<br>ê²€ìƒ‰ìˆ˜</div>
                <div class="header-cell">PC<br>í´ë¦­ìˆ˜</div>
                <div class="header-cell">ëª¨ë°”ì¼<br>í´ë¦­ìˆ˜</div>
                <div class="header-cell">PC<br>CTR</div>
                <div class="header-cell">ëª¨ë°”ì¼<br>CTR</div>
                <div class="header-cell">í‰ê· ë…¸ì¶œ<br>ê´‘ê³ ìˆ˜</div>
                <div class="header-cell">ê²½ìŸ<br>ì •ë„</div>
                <div class="header-cell">API</div>
                <div class="header-cell">ì—ëŸ¬</div>
            </div>
            <div id="spacer" style="position: relative;">
                <div id="content" style="position: absolute; top: 0; left: 0; right: 0;"></div>
            </div>
        </div>
        
        <p class="tip">
            ğŸ’¡ API í‚¤ëŠ” ë¸Œë¼ìš°ì €ì— ì•ˆì „í•˜ê²Œ ì €ì¥ë˜ë©°, íŒŒì¼ë¡œ ë‚´ë³´ë‚´ê±°ë‚˜ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </p>
    </div>

    <!-- API ì„¤ì • ëª¨ë‹¬ -->
    <div class="modal" id="apiModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ğŸ”‘ API ì„¤ì •</h2>
                <button class="close-btn" onclick="closeApiModal()">&times;</button>
            </div>
            
            <div class="alert alert-info">
                ë„¤ì´ë²„ ê²€ìƒ‰ê´‘ê³  API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”. ìµœëŒ€ 30ê°œì˜ APIë¥¼ ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </div>
            
            <div id="apiConfigList">
                <!-- API ì„¤ì • í¼ì´ ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
            </div>
            
            <div class="btn-group">
                <button class="btn btn-warning" onclick="addApiConfig()">+ API ì¶”ê°€</button>
                <button class="btn btn-success" onclick="saveApiConfigs()">ğŸ’¾ ì €ì¥</button>
                <div class="file-input-wrapper">
                    <input type="file" id="importFile" class="file-input" accept=".json" onchange="importApiKeys(event)">
                    <label for="importFile" class="file-label">ğŸ“‚ ê°€ì ¸ì˜¤ê¸°</label>
                </div>
                <button class="btn btn-info" onclick="exportApiKeys()">ğŸ’¾ ë‚´ë³´ë‚´ê¸°</button>
                <button class="btn btn-info" onclick="loadDefaultAPIs()">ğŸ“‹ ê¸°ë³¸ API (15ê°œ)</button>
            </div>
        </div>
    </div>

<script>
// ì „ì—­ ë³€ìˆ˜
let apiConfigs = [];
let allRows = [];
let virtualScroll = null;
let cacheManager = null;
let currentApiIndex = 0; // í˜„ì¬ ì‚¬ìš© ì¤‘ì¸ API ì¸ë±ìŠ¤
const ROW_HEIGHT = 49;

// IndexedDB ìºì‹œ ë§¤ë‹ˆì € í´ë˜ìŠ¤
class CacheManager {
    constructor() {
        this.dbName = 'NaverSearchCache';
        this.storeName = 'keywords';
        this.db = null;
        this.initPromise = this.initDB();
    }

    async initDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(this.dbName, 1);
            
            request.onerror = () => reject(request.error);
            request.onsuccess = () => {
                this.db = request.result;
                resolve();
            };
            
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains(this.storeName)) {
                    const store = db.createObjectStore(this.storeName, { keyPath: 'keyword' });
                    store.createIndex('timestamp', 'timestamp', { unique: false });
                }
            };
        });
    }

    async get(keyword) {
        await this.initPromise;
        return new Promise((resolve) => {
            const transaction = this.db.transaction([this.storeName], 'readonly');
            const store = transaction.objectStore(this.storeName);
            const request = store.get(keyword);
            
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => resolve(null);
        });
    }

    async set(keyword, data) {
        await this.initPromise;
        return new Promise((resolve) => {
            const transaction = this.db.transaction([this.storeName], 'readwrite');
            const store = transaction.objectStore(this.storeName);
            const request = store.put({
                ...data,
                keyword,
                timestamp: Date.now()
            });
            
            request.onsuccess = () => resolve(true);
            request.onerror = () => resolve(false);
        });
    }

    async clear() {
        await this.initPromise;
        return new Promise((resolve) => {
            const transaction = this.db.transaction([this.storeName], 'readwrite');
            const store = transaction.objectStore(this.storeName);
            const request = store.clear();
            
            request.onsuccess = () => resolve(true);
            request.onerror = () => resolve(false);
        });
    }

    async getSize() {
        await this.initPromise;
        return new Promise((resolve) => {
            const transaction = this.db.transaction([this.storeName], 'readonly');
            const store = transaction.objectStore(this.storeName);
            const request = store.count();
            
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => resolve(0);
        });
    }
}

// ê°€ìƒ ìŠ¤í¬ë¡¤ í´ë˜ìŠ¤
class VirtualScroll {
    constructor(container, contentEl, spacerEl) {
        this.container = container;
        this.contentEl = contentEl;
        this.spacerEl = spacerEl;
        this.items = [];
        this.itemHeight = ROW_HEIGHT;
        this.visible = 30;
        this.scrollTop = 0;
        this.start = 0;
        
        this.container.addEventListener('scroll', () => {
            this.scrollTop = this.container.scrollTop;
            this.render();
        });
    }

    updateItems(items) {
        this.items = items;
        this.spacerEl.style.height = `${this.items.length * this.itemHeight}px`;
        this.render();
    }

    render() {
        this.start = Math.floor(this.scrollTop / this.itemHeight);
        const end = Math.min(this.start + this.visible, this.items.length);
        
        const fragment = document.createDocumentFragment();
        
        for (let i = this.start; i < end; i++) {
            const row = this.items[i];
            const div = document.createElement('div');
            div.className = row.fromCache ? 'table-row cached' : 'table-row';
            
            const pc = parseInt(row.monthlyPcQcCnt) || 0;
            const mo = parseInt(row.monthlyMobileQcCnt) || 0;
            const total = pc + mo;
            
            // ëª¨ë“  ì…€ ì¤‘ì•™ ì •ë ¬ (í‚¤ì›Œë“œë§Œ ì¢Œì¸¡)
            div.innerHTML = `
                <div class="table-cell keyword">${this.escapeHtml(row.keyword)}</div>
                <div class="table-cell">${total.toLocaleString()}</div>
                <div class="table-cell">${pc.toLocaleString()}</div>
                <div class="table-cell">${mo.toLocaleString()}</div>
                <div class="table-cell">${row.monthlyAvePcClkCnt || '-'}</div>
                <div class="table-cell">${row.monthlyAveMobileClkCnt || '-'}</div>
                <div class="table-cell">${row.monthlyAvePcCtr || '-'}</div>
                <div class="table-cell">${row.monthlyAveMobileCtr || '-'}</div>
                <div class="table-cell">${row.plAvgDepth || '-'}</div>
                <div class="table-cell">${row.compIdx || '-'}</div>
                <div class="table-cell api-cell">
                    ${row.fromCache ? 
                        '<span style="color: #28a745;">ìºì‹œ</span>' : 
                        (row.api_used ? `<span style="color: #007bff;">${row.api_used}</span>` : '-')}
                </div>
                <div class="table-cell">${row.error || ''}</div>
            `;
            
            fragment.appendChild(div);
        }
        
        this.contentEl.innerHTML = '';
        this.contentEl.appendChild(fragment);
        this.contentEl.style.transform = `translateY(${this.start * this.itemHeight}px)`;
    }

    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
}

// ì´ˆê¸°í™” í•¨ìˆ˜
async function init() {
    // LocalStorageì—ì„œ API ì„¤ì • ë¡œë“œ
    const savedConfigs = localStorage.getItem('naverApiConfigs');
    if (savedConfigs) {
        try {
            apiConfigs = JSON.parse(savedConfigs);
            updateApiIndicators();
        } catch (e) {
            console.error('API ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:', e);
        }
    }
    
    // ìºì‹œ ë§¤ë‹ˆì € ì´ˆê¸°í™”
    cacheManager = new CacheManager();
    await updateCacheInfo();
    
    // ê°€ìƒ ìŠ¤í¬ë¡¤ ì´ˆê¸°í™”
    const scrollContainer = document.getElementById('scrollContainer');
    const content = document.getElementById('content');
    const spacer = document.getElementById('spacer');
    if (scrollContainer && content && spacer) {
        virtualScroll = new VirtualScroll(scrollContainer, content, spacer);
    }
    
    // í‚¤ì›Œë“œ ì…ë ¥ í•„ë“œì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (ë„ì–´ì“°ê¸° ìë™ ì œê±°)
    const keywordInput = document.getElementById('kw');
    if (keywordInput) {
        // ë¶™ì—¬ë„£ê¸° ì´ë²¤íŠ¸ ì²˜ë¦¬
        keywordInput.addEventListener('paste', function(e) {
            e.preventDefault();
            let pastedText = (e.clipboardData || window.clipboardData).getData('text');
            
            // ê° ì¤„ì—ì„œ ë„ì–´ì“°ê¸° ì œê±°
            const lines = pastedText.split(/[\n,]+/);
            const processedLines = lines.map(line => line.trim().replace(/\s+/g, ''));
            const processedText = processedLines.join('\n');
            
            // í˜„ì¬ ì»¤ì„œ ìœ„ì¹˜ì— ì‚½ì…
            const start = this.selectionStart;
            const end = this.selectionEnd;
            const currentValue = this.value;
            
            this.value = currentValue.substring(0, start) + processedText + currentValue.substring(end);
            
            // ì»¤ì„œ ìœ„ì¹˜ ì¡°ì •
            const newPos = start + processedText.length;
            this.setSelectionRange(newPos, newPos);
        });
        
        // ì‚¬ìš©ìê°€ ì…ë ¥í•  ë•Œ ì•ˆë‚´ ë©”ì‹œì§€ í‘œì‹œ (ì„ íƒì‚¬í•­)
        keywordInput.setAttribute('placeholder', 'í‚¤ì›Œë“œ ì…ë ¥ (ë„ì–´ì“°ê¸°ëŠ” ìë™ ì œê±°ë©ë‹ˆë‹¤)\nì˜ˆ: ì„œìš¸ ë§›ì§‘ â†’ ì„œìš¸ë§›ì§‘');
    }
}

// API ì„¤ì • ëª¨ë‹¬ ì—´ê¸°
function openApiModal() {
    document.getElementById('apiModal').classList.add('active');
    renderApiConfigs();
}

// API ì„¤ì • ëª¨ë‹¬ ë‹«ê¸°
function closeApiModal() {
    document.getElementById('apiModal').classList.remove('active');
}

// API ì„¤ì • í¼ ë Œë”ë§
function renderApiConfigs() {
    const container = document.getElementById('apiConfigList');
    container.innerHTML = '';
    
    // ìµœì†Œ 1ê°œëŠ” í‘œì‹œ
    const configs = apiConfigs.length > 0 ? apiConfigs : [{}];
    
    configs.forEach((config, index) => {
        const section = document.createElement('div');
        section.className = 'api-config-section';
        section.innerHTML = `
            <div class="api-config-header">
                <h3 class="api-config-title">API ${index + 1}</h3>
                ${configs.length > 1 ? `<button class="api-remove-btn" onclick="removeApiConfig(${index})">ì‚­ì œ</button>` : ''}
            </div>
            <div class="api-config-grid">
                <div class="form-group">
                    <label>Customer ID</label>
                    <input type="text" id="customerId_${index}" value="${config.customerId || ''}" placeholder="ì˜ˆ: 2521363">
                </div>
                <div class="form-group">
                    <label>Access License</label>
                    <input type="text" id="accessLicense_${index}" value="${config.accessLicense || ''}" placeholder="01000000...">
                </div>
                <div class="form-group">
                    <label>Secret Key</label>
                    <input type="text" id="secretKey_${index}" value="${config.secretKey || ''}" placeholder="AQA...">
                </div>
                <div class="form-group">
                    <label>API ì´ë¦„ (ì„ íƒì‚¬í•­)</label>
                    <input type="text" id="apiName_${index}" value="${config.name || `API ${index + 1}`}" placeholder="ì˜ˆ: ë©”ì¸ API">
                </div>
            </div>
        `;
        container.appendChild(section);
    });
}

// API ì„¤ì • ì¶”ê°€
function addApiConfig() {
    if (apiConfigs.length >= 30) {
        showAlert('ìµœëŒ€ 30ê°œì˜ APIë§Œ ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'danger');
        return;
    }
    apiConfigs.push({});
    renderApiConfigs();
}

// API ì„¤ì • ì‚­ì œ
function removeApiConfig(index) {
    apiConfigs.splice(index, 1);
    renderApiConfigs();
}

// API ì„¤ì • ì €ì¥
function saveApiConfigs() {
    const configs = [];
    const maxIndex = apiConfigs.length || 1;
    
    for (let i = 0; i < maxIndex; i++) {
        const customerId = document.getElementById(`customerId_${i}`)?.value.trim();
        const accessLicense = document.getElementById(`accessLicense_${i}`)?.value.trim();
        const secretKey = document.getElementById(`secretKey_${i}`)?.value.trim();
        const apiName = document.getElementById(`apiName_${i}`)?.value.trim() || `API ${i + 1}`;
        
        if (customerId && accessLicense && secretKey) {
            configs.push({
                customerId,
                accessLicense,
                secretKey,
                name: apiName
            });
        }
    }
    
    if (configs.length === 0) {
        showAlert('ìµœì†Œ 1ê°œì˜ API ì„¤ì •ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'danger');
        return;
    }
    
    apiConfigs = configs;
    localStorage.setItem('naverApiConfigs', JSON.stringify(apiConfigs));
    updateApiIndicators();
    closeApiModal();
    showAlert(`${configs.length}ê°œì˜ API ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
}

// API í‚¤ ë‚´ë³´ë‚´ê¸°
function exportApiKeys() {
    if (apiConfigs.length === 0) {
        showAlert('ì €ì¥ëœ API ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤.', 'danger');
        return;
    }
    
    const data = {
        version: '3.0',
        timestamp: new Date().toISOString(),
        configs: apiConfigs
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `naver_api_keys_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    URL.revokeObjectURL(url);
    
    showAlert('API í‚¤ê°€ íŒŒì¼ë¡œ ë‚´ë³´ë‚´ê¸° ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
}

// ê¸°ë³¸ API (15ê°œ) ë¶ˆëŸ¬ì˜¤ê¸°
async function loadDefaultAPIs() {
    try {
        const response = await fetch('15ea_naver_api_keys.json');
        if (!response.ok) {
            throw new Error('íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
        
        const data = await response.json();
        if (data.configs && Array.isArray(data.configs)) {
            // ê¸°ì¡´ APIì™€ ë³‘í•©í• ì§€ ë¬¼ì–´ë³´ê¸°
            if (apiConfigs.length > 0) {
                if (!confirm('ê¸°ì¡´ API ì„¤ì •ì„ ë®ì–´ì”Œìš°ì‹œê² ìŠµë‹ˆê¹Œ?\n\n"ì·¨ì†Œ"ë¥¼ ëˆ„ë¥´ë©´ ê¸°ì¡´ ì„¤ì •ì— ì¶”ê°€ë©ë‹ˆë‹¤.')) {
                    // ê¸°ì¡´ ì„¤ì •ì— ì¶”ê°€
                    apiConfigs = [...apiConfigs, ...data.configs];
                    if (apiConfigs.length > 30) {
                        apiConfigs = apiConfigs.slice(0, 30);
                        showAlert(`ìµœëŒ€ 30ê°œê¹Œì§€ë§Œ ë“±ë¡ ê°€ëŠ¥í•©ë‹ˆë‹¤. ${data.configs.length}ê°œ ì¤‘ ì¼ë¶€ë§Œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'warning');
                    } else {
                        showAlert(`${data.configs.length}ê°œì˜ ê¸°ë³¸ APIê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                    }
                } else {
                    // ê¸°ì¡´ ì„¤ì • ë®ì–´ì“°ê¸°
                    apiConfigs = data.configs;
                    showAlert(`${apiConfigs.length}ê°œì˜ ê¸°ë³¸ APIë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`, 'success');
                }
            } else {
                // ë¹ˆ ìƒíƒœì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°
                apiConfigs = data.configs;
                showAlert(`${apiConfigs.length}ê°œì˜ ê¸°ë³¸ APIë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`, 'success');
            }
            
            localStorage.setItem('naverApiConfigs', JSON.stringify(apiConfigs));
            renderApiConfigs();
            updateApiIndicators();
        } else {
            showAlert('ì˜¬ë°”ë¥¸ API ì„¤ì • íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤.', 'danger');
        }
    } catch (err) {
        showAlert('ê¸°ë³¸ API íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨: ' + err.message, 'danger');
        console.error('Error loading default APIs:', err);
    }
}

// API í‚¤ ê°€ì ¸ì˜¤ê¸°
function importApiKeys(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const data = JSON.parse(e.target.result);
            if (data.configs && Array.isArray(data.configs)) {
                apiConfigs = data.configs;
                localStorage.setItem('naverApiConfigs', JSON.stringify(apiConfigs));
                renderApiConfigs();
                updateApiIndicators();
                showAlert(`${apiConfigs.length}ê°œì˜ API ì„¤ì •ì„ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤.`, 'success');
            } else {
                showAlert('ì˜¬ë°”ë¥¸ API ì„¤ì • íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤.', 'danger');
            }
        } catch (err) {
            showAlert('íŒŒì¼ ì½ê¸° ì‹¤íŒ¨: ' + err.message, 'danger');
        }
    };
    reader.readAsText(file);
}

// API ìƒíƒœ ì¸ë””ì¼€ì´í„° ì—…ë°ì´íŠ¸
function updateApiIndicators() {
    const container = document.getElementById('apiIndicators');
    
    if (apiConfigs.length === 0) {
        container.innerHTML = `
            <div class="api-indicator inactive">
                <span>ì„¤ì •ëœ APIê°€ ì—†ìŠµë‹ˆë‹¤. ìš°ì¸¡ ìƒë‹¨ì˜ ì„¤ì • ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</span>
            </div>
        `;
        return;
    }
    
    container.innerHTML = '';
    apiConfigs.forEach((config, index) => {
        const indicator = document.createElement('div');
        indicator.className = 'api-indicator inactive';
        indicator.id = `api-${index}`;
        indicator.innerHTML = `
            <span style="width: 8px; height: 8px; border-radius: 50%; background: currentColor;"></span>
            <span>${config.name || `API ${index + 1}`}</span>
        `;
        container.appendChild(indicator);
    });
    
    // batchSize ê¸°ë³¸ê°’ì„ API ê°œìˆ˜ì˜ 70%ë¡œ ìë™ ì—…ë°ì´íŠ¸
    const batchSizeInput = document.getElementById('batchSize');
    if (batchSizeInput) {
        const suggestedBatchSize = Math.max(1, Math.floor(apiConfigs.length * 0.7));
        // í˜„ì¬ ê°’ì´ ê¸°ë³¸ê°’(3)ì´ê±°ë‚˜ ì‚¬ìš©ìê°€ ìˆ˜ì •í•˜ì§€ ì•Šì•˜ìœ¼ë©´ ìë™ ì—…ë°ì´íŠ¸
        if (batchSizeInput.value === '3' || batchSizeInput.value === '' || parseInt(batchSizeInput.value) > apiConfigs.length) {
            batchSizeInput.value = suggestedBatchSize;
            // placeholderì— ê¶Œì¥ê°’ í‘œì‹œ
            batchSizeInput.setAttribute('placeholder', `ê¶Œì¥: ${suggestedBatchSize}`);
        }
        // max ì†ì„±ë„ API ê°œìˆ˜ë¡œ ì—…ë°ì´íŠ¸
        batchSizeInput.setAttribute('max', apiConfigs.length);
    }
}

// ì•Œë¦¼ í‘œì‹œ
function showAlert(message, type) {
    const alertArea = document.getElementById('alertArea');
    const alert = document.createElement('div');
    alert.className = `alert alert-${type}`;
    alert.textContent = message;
    
    alertArea.innerHTML = '';
    alertArea.appendChild(alert);
    
    // 20ì´ˆ í›„ì— ì‚¬ë¼ì§€ë„ë¡ ë³€ê²½
    setTimeout(() => {
        alert.remove();
    }, 20000);
}

// ìºì‹œ ì •ë³´ ì—…ë°ì´íŠ¸
async function updateCacheInfo() {
    if (!cacheManager) return;
    const size = await cacheManager.getSize();
    const cacheInfo = document.getElementById('cacheInfo');
    if (cacheInfo) {
        cacheInfo.textContent = `ìºì‹œ: ${size.toLocaleString()}ê°œ ì €ì¥ë¨`;
    }
}

// ìºì‹œ ì´ˆê¸°í™”
async function clearCache() {
    if (confirm('ì •ë§ ìºì‹œë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        await cacheManager.clear();
        await updateCacheInfo();
        showAlert('ìºì‹œê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
    }
}

// API í˜¸ì¶œ í•¨ìˆ˜ - ë¼ìš´ë“œ ë¡œë¹ˆ ë°©ì‹ìœ¼ë¡œ ê°œì„  (ì¬ì‹œë„ ì‹œ ë‹¤ë¥¸ API ì‚¬ìš©)
async function callNaverAPI(keyword, apiIndex = null, retryCount = 1, requestInterval = 100) {
    if (apiConfigs.length === 0) {
        throw new Error('API ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤.');
    }
    
    let lastError = null;
    let attempts = 0;
    const maxAttempts = Math.min(retryCount + 1, apiConfigs.length * 2); // ìµœëŒ€ ì‹œë„ íšŸìˆ˜ ì œí•œ
    
    // ì‚¬ìš©í•œ API ì¸ë±ìŠ¤ ì¶”ì  (ì¤‘ë³µ ë°©ì§€)
    const usedIndices = new Set();
    
    while (attempts < maxAttempts) {
        // ë§¤ ì‹œë„ë§ˆë‹¤ ë‹¤ë¥¸ API ì‚¬ìš©
        let useIndex;
        
        if (attempts === 0 && apiIndex !== null) {
            // ì²« ì‹œë„ì—ì„œ ì§€ì •ëœ APIê°€ ìˆìœ¼ë©´ ì‚¬ìš©
            useIndex = apiIndex;
        } else {
            // ì¬ì‹œë„ ì‹œ ë‹¤ìŒ API ì„ íƒ
            // ëª¨ë“  APIë¥¼ ìˆœí™˜í•˜ë©´ì„œ ì‹œë„
            for (let i = 0; i < apiConfigs.length; i++) {
                const nextIndex = (currentApiIndex + i) % apiConfigs.length;
                if (!usedIndices.has(nextIndex) || usedIndices.size >= apiConfigs.length) {
                    useIndex = nextIndex;
                    currentApiIndex = (nextIndex + 1) % apiConfigs.length;
                    break;
                }
            }
        }
        
        usedIndices.add(useIndex);
        const apiConfig = apiConfigs[useIndex];
        const apiName = apiConfig.name || `API ${useIndex + 1}`;
        
        try {
            if (attempts > 0) {
                console.log(`ğŸ”„ ì¬ì‹œë„ ${attempts}/${retryCount}: ${apiName} ì‚¬ìš© (í‚¤ì›Œë“œ: ${keyword})`);
                // ì¬ì‹œë„ ì‹œì—ë„ API ì¸ë””ì¼€ì´í„° ì—…ë°ì´íŠ¸
                updateActiveApiIndicator(useIndex);
            }
            
            const response = await fetch('api_batch.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    keyword: keyword,
                    apiConfig: apiConfig,
                    apiName: apiName
                })
            });
            
            // ì‘ë‹µ í…ìŠ¤íŠ¸ë¥¼ ë¨¼ì € ê°€ì ¸ì˜´
            const responseText = await response.text();
            
            // ì„±ê³µí•œ ê²½ìš°
            if (response.ok) {
                try {
                    const result = JSON.parse(responseText);
                    result.api_used = apiName;
                    if (attempts > 0) {
                        console.log(`âœ… ì¬ì‹œë„ ì„±ê³µ: ${apiName} (í‚¤ì›Œë“œ: ${keyword}, ${attempts}íšŒ ì¬ì‹œë„ í›„)`);
                    }
                    return result;
                } catch (parseError) {
                    throw new Error(`JSON íŒŒì‹± ì‹¤íŒ¨ (${apiName}): ${responseText}`);
                }
            }
            
            // ì—ëŸ¬ ì²˜ë¦¬
            let errorMsg = `API Error ${response.status} (${apiName})`;
            
            // ì—ëŸ¬ ì‘ë‹µ íŒŒì‹± ì‹œë„
            try {
                const errorData = JSON.parse(responseText);
                if (errorData.error) {
                    errorMsg = `${apiName}: ${errorData.error}`;
                }
            } catch (e) {
                errorMsg += `: ${responseText}`;
            }
            
            lastError = new Error(errorMsg);
            
            // Rate Limit ì—ëŸ¬ íŠ¹ë³„ ì²˜ë¦¬
            if (response.status === 429) {
                console.warn(`âš ï¸ Rate Limit ì´ˆê³¼ (${apiName}): ì¼ì¼ í•œë„ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤.`);
            } else {
                console.warn(`âŒ ${errorMsg}`);
            }
            
            attempts++;
            
            if (attempts < maxAttempts && attempts <= apiConfigs.length) {
                // ì¬ì‹œë„ ì „ ëŒ€ê¸° - ìš”ì²­ ê°„ê²©ê³¼ ë™ì¼í•˜ê²Œ ì„¤ì •
                console.log(`â³ ${requestInterval}ms í›„ ë‹¤ë¥¸ APIë¡œ ì¬ì‹œë„... (ì‹œë„ ${attempts + 1}/${maxAttempts}, ë‹¤ìŒ APIë¡œ ì „í™˜)`);
                await new Promise(resolve => setTimeout(resolve, requestInterval));
                continue;
            }
            
        } catch (error) {
            // ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬ ë˜ëŠ” ê¸°íƒ€ ì—ëŸ¬
            lastError = error;
            console.error(`âŒ ì—ëŸ¬ ë°œìƒ (${apiName}): ${error.message}`);
            attempts++;
            
            if (attempts < maxAttempts) {
                console.log(`â³ ${requestInterval}ms í›„ ë‹¤ë¥¸ APIë¡œ ì¬ì‹œë„... (ì‹œë„ ${attempts + 1}/${maxAttempts})`);
                await new Promise(resolve => setTimeout(resolve, requestInterval));
            }
        }
    }
    
    // ëª¨ë“  ì¬ì‹œë„ ì‹¤íŒ¨
    console.error(`ğŸ’€ ìµœì¢… ì‹¤íŒ¨ (${attempts}íšŒ ì‹œë„, í‚¤ì›Œë“œ: ${keyword}): ${lastError?.message}`);
    throw lastError || new Error('API í˜¸ì¶œ ì‹¤íŒ¨');
}

// ë°°ì¹˜ ì²˜ë¦¬ í•¨ìˆ˜ - ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì§€ì›
async function processBatch(keywords, batchSize, requestInterval, useCache, retryCount = 1) {
    const batchStatus = document.getElementById('batchStatus');
    const results = [];
    let totalProcessed = 0;
    
    // ë°°ì¹˜ ìƒíƒœ í‘œì‹œ
    batchStatus.style.display = 'inline-block';
    
    for (let i = 0; i < keywords.length; i += batchSize) {
        const batch = keywords.slice(i, Math.min(i + batchSize, keywords.length));
        const batchPromises = [];
        
        // ë°°ì¹˜ ìƒíƒœ ì—…ë°ì´íŠ¸ - ìˆ«ìë¡œ í‘œê¸°
        const batchStart = i + 1;
        const batchEnd = Math.min(i + batchSize, keywords.length);
        batchStatus.textContent = `ë°°ì¹˜ ì²˜ë¦¬ì¤‘: ${batchStart}-${batchEnd} / ${keywords.length}`;
        
        for (const keyword of batch) {
            // ìºì‹œ í™•ì¸
            if (useCache && cacheManager) {
                const cached = await cacheManager.get(keyword);
                if (cached) {
                    const result = {
                        ...cached,
                        fromCache: true,
                        api_used: 'ìºì‹œ'
                    };
                    results.push(result);
                    
                    // ì‹¤ì‹œê°„ìœ¼ë¡œ í…Œì´ë¸”ì— ì¶”ê°€
                    allRows.push(result);
                    virtualScroll.updateItems(allRows);
                    
                    totalProcessed++;
                    document.getElementById('prog').value = totalProcessed;
                    document.getElementById('status').textContent = `${totalProcessed}/${keywords.length} ì²˜ë¦¬ ì™„ë£Œ`;
                    continue;
                }
            }
            
            // API í˜¸ì¶œ (Promise ë°°ì—´ì— ì¶”ê°€)
            const apiPromise = (async () => {
                try {
                    // í˜„ì¬ ì‚¬ìš©í•  API ê²°ì • (ê° í‚¤ì›Œë“œë§ˆë‹¤ ë‹¤ë¥¸ API ì‚¬ìš© ê°€ëŠ¥)
                    const apiIndex = currentApiIndex;
                    currentApiIndex = (currentApiIndex + 1) % apiConfigs.length;
                    
                    // API ì¸ë””ì¼€ì´í„° í™œì„±í™”
                    updateActiveApiIndicator(apiIndex);
                    
                    const result = await callNaverAPI(keyword, apiIndex, retryCount, requestInterval);
                    
                    // ìºì‹œ ì €ì¥
                    if (useCache && cacheManager && !result.error) {
                        await cacheManager.set(keyword, result);
                    }
                    
                    // api_usedê°€ ì´ë¯¸ ì„¤ì •ë˜ì–´ ìˆìŒ (callNaverAPIì—ì„œ ì„¤ì •)
                    
                    // ì‹¤ì‹œê°„ìœ¼ë¡œ í…Œì´ë¸”ì— ì¶”ê°€
                    allRows.push(result);
                    virtualScroll.updateItems(allRows);
                    
                    totalProcessed++;
                    document.getElementById('prog').value = totalProcessed;
                    document.getElementById('status').textContent = `${totalProcessed}/${keywords.length} ì²˜ë¦¬ ì™„ë£Œ`;
                    
                    return result;
                } catch (error) {
                    const errorResult = {
                        keyword: keyword,
                        error: error.message,
                        api_used: 'ì—ëŸ¬ (ì¬ì‹œë„ ì™„ë£Œ)'
                    };
                    
                    // ì—ëŸ¬ë„ ì‹¤ì‹œê°„ìœ¼ë¡œ í…Œì´ë¸”ì— ì¶”ê°€
                    allRows.push(errorResult);
                    virtualScroll.updateItems(allRows);
                    
                    totalProcessed++;
                    document.getElementById('prog').value = totalProcessed;
                    document.getElementById('status').textContent = `${totalProcessed}/${keywords.length} ì²˜ë¦¬ ì™„ë£Œ`;
                    
                    return errorResult;
                }
            })();
            
            batchPromises.push(apiPromise);
        }
        
        // ë°°ì¹˜ ì™„ë£Œ ëŒ€ê¸°
        const batchResults = await Promise.all(batchPromises);
        results.push(...batchResults);
        
        // ë‹¤ìŒ ë°°ì¹˜ ì „ ëŒ€ê¸°
        if (i + batchSize < keywords.length) {
            await new Promise(resolve => setTimeout(resolve, requestInterval));
        }
    }
    
    return results;
}

// API ì¸ë””ì¼€ì´í„° í™œì„±í™” í•¨ìˆ˜
function updateActiveApiIndicator(apiIndex) {
    // ëª¨ë“  ì¸ë””ì¼€ì´í„° ë¹„í™œì„±í™”
    document.querySelectorAll('.api-indicator').forEach(ind => {
        ind.classList.remove('active');
        ind.classList.add('inactive');
    });
    
    // í˜„ì¬ API ì¸ë””ì¼€ì´í„° í™œì„±í™”
    const indicator = document.getElementById(`api-${apiIndex}`);
    if (indicator) {
        indicator.classList.remove('inactive');
        indicator.classList.add('active');
        
        // 500ms í›„ ì›ë˜ ìƒíƒœë¡œ ë³µê·€
        setTimeout(() => {
            indicator.classList.remove('active');
            indicator.classList.add('inactive');
        }, 500);
    }
}

// ê²€ìƒ‰ ì‹¤í–‰ - ë°°ì¹˜ ì²˜ë¦¬ ë°©ì‹ìœ¼ë¡œ ê°œì„ 
async function runSearch() {
    const keywordInput = document.getElementById('kw').value.trim();
    if (!keywordInput) {
        showAlert('í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.', 'danger');
        return;
    }
    
    if (apiConfigs.length === 0) {
        showAlert('API ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤. ìš°ì¸¡ ìƒë‹¨ì˜ ì„¤ì • ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.', 'danger');
        return;
    }
    
    // UI ì´ˆê¸°í™”
    const runBtn = document.getElementById('runBtn');
    const csvBtn = document.getElementById('csvBtn');
    const xlsxBtn = document.getElementById('xlsxBtn');
    const status = document.getElementById('status');
    const prog = document.getElementById('prog');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const scrollContainer = document.getElementById('scrollContainer');
    const batchStatus = document.getElementById('batchStatus');
    
    runBtn.disabled = true;
    csvBtn.disabled = true;
    xlsxBtn.disabled = true;
    prog.style.display = 'inline';
    prog.value = 0;
    status.textContent = 'ì²˜ë¦¬ ì¤‘...';
    scrollContainer.style.display = 'block';
    loadingIndicator.style.display = 'inline-block';
    
    // íŒŒë¼ë¯¸í„°
    const requestInterval = parseInt(document.getElementById('interval').value) || 100;
    
    // batchSizeë¥¼ ë“±ë¡ëœ API ê°œìˆ˜ì˜ 70%ë¡œ ìë™ ì„¤ì • (ìµœì†Œ 1, ìµœëŒ€ ë“±ë¡ëœ API ìˆ˜)
    const suggestedBatchSize = Math.max(1, Math.floor(apiConfigs.length * 0.7));
    const batchSizeInput = document.getElementById('batchSize');
    let batchSize = parseInt(batchSizeInput.value) || suggestedBatchSize;
    
    // ë§Œì•½ í˜„ì¬ ê°’ì´ ê¸°ë³¸ê°’(3)ì´ê±°ë‚˜ API ê°œìˆ˜ê°€ ë³€ê²½ë˜ì—ˆë‹¤ë©´ ìë™ ì¡°ì •
    if (batchSizeInput.value === '3' || batchSize > apiConfigs.length) {
        batchSize = suggestedBatchSize;
        batchSizeInput.value = batchSize;
    }
    
    const useCache = document.getElementById('useCache').checked;
    const retryCount = parseInt(document.getElementById('retryCount').value) || 3;
    
    // í‚¤ì›Œë“œ íŒŒì‹± - ë„ì–´ì“°ê¸° ì œê±° ì¶”ê°€
    const keywords = keywordInput.split(/[\n,]+/)
        .map(k => k.trim().replace(/\s+/g, ''))  // ëª¨ë“  ë„ì–´ì“°ê¸° ì œê±°
        .filter(k => k);
    
    prog.max = keywords.length;
    allRows = [];
    currentApiIndex = 0; // API ì¸ë±ìŠ¤ ì´ˆê¸°í™”
    
    try {
        const startTime = Date.now();
        
        // ë°°ì¹˜ ì²˜ë¦¬ ì‹¤í–‰ (ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ëŠ” processBatch ë‚´ë¶€ì—ì„œ ì²˜ë¦¬)
        const results = await processBatch(keywords, batchSize, requestInterval, useCache, retryCount);
        
        // API ì‚¬ìš© í†µê³„ ìˆ˜ì§‘
        const apiUsageStats = {};
        let retrySuccessCount = 0;
        let retryFailCount = 0;
        
        for (const result of results) {
            if (result.api_used && !result.fromCache && result.api_used !== 'ìºì‹œ' && result.api_used !== 'ì—ëŸ¬' && result.api_used !== 'ì—ëŸ¬ (ì¬ì‹œë„ ì™„ë£Œ)') {
                apiUsageStats[result.api_used] = (apiUsageStats[result.api_used] || 0) + 1;
            }
            // ì¬ì‹œë„ í†µê³„
            if (result.error && result.api_used === 'ì—ëŸ¬ (ì¬ì‹œë„ ì™„ë£Œ)') {
                retryFailCount++;
            }
        }
        
        // ì™„ë£Œ
        const elapsedTime = ((Date.now() - startTime) / 1000).toFixed(1);
        status.textContent = `âœ… ì™„ë£Œ! ${keywords.length}ê°œ ì²˜ë¦¬ë¨ (${elapsedTime}ì´ˆ)`;
        csvBtn.disabled = false;
        xlsxBtn.disabled = false;
        batchStatus.style.display = 'none';
        prog.style.display = 'none';
        
        // API ì¸ë””ì¼€ì´í„° ë¹„í™œì„±í™”
        document.querySelectorAll('.api-indicator').forEach(ind => {
            ind.classList.remove('active');
            ind.classList.add('inactive');
        });
        
        // API ì‚¬ìš© í†µê³„ í‘œì‹œ
        if (Object.keys(apiUsageStats).length > 0 || errorCount > 0) {
            const statsText = Object.entries(apiUsageStats)
                .map(([api, count]) => `${api}: ${count}`)
                .join(', ');
            
            const cacheCount = results.filter(r => r.fromCache).length;
            const apiCount = results.filter(r => !r.fromCache && r.api_used !== 'ì—ëŸ¬' && r.api_used !== 'ì—ëŸ¬ (ì¬ì‹œë„ ì™„ë£Œ)').length;
            const errorCount = results.filter(r => r.error).length;
            
            let alertMessage = `ì²˜ë¦¬ ì™„ë£Œ! API í˜¸ì¶œ: ${apiCount}ê°œ, ìºì‹œ: ${cacheCount}ê°œ`;
            if (errorCount > 0) {
                alertMessage += `, ì—ëŸ¬: ${errorCount}ê°œ`;
                if (retryCount > 0) {
                    alertMessage += ` (ì¬ì‹œë„ ${retryCount}íšŒ ì„¤ì •ë¨)`;
                }
            }
            if (statsText) {
                alertMessage += ` | APIë³„ ì‚¬ìš©: ${statsText}`;
            }
            
            showAlert(alertMessage, errorCount > 0 ? 'warning' : 'success');
        } else {
            showAlert(`ì²˜ë¦¬ ì™„ë£Œ! ${keywords.length}ê°œ í‚¤ì›Œë“œ ì²˜ë¦¬ë¨`, 'success');
        }
        
    } catch (err) {
        console.error('ê²€ìƒ‰ ì˜¤ë¥˜:', err);
        status.textContent = 'âŒ ì˜¤ë¥˜ ë°œìƒ: ' + err.message;
        showAlert('ì˜¤ë¥˜ ë°œìƒ: ' + err.message, 'danger');
    } finally {
        runBtn.disabled = false;
        loadingIndicator.style.display = 'none';
        batchStatus.style.display = 'none';
        await updateCacheInfo();
    }
}

// CSV ë‹¤ìš´ë¡œë“œ
function downloadCSV() {
    if (allRows.length === 0) return;
    
    const headers = ['í‚¤ì›Œë“œ', 'ì´ê²€ìƒ‰ìˆ˜', 'PCê²€ìƒ‰ìˆ˜', 'ëª¨ë°”ì¼ê²€ìƒ‰ìˆ˜', 'PCí´ë¦­ìˆ˜', 'ëª¨ë°”ì¼í´ë¦­ìˆ˜',
                     'PC_CTR', 'ëª¨ë°”ì¼_CTR', 'í‰ê· ë…¸ì¶œê´‘ê³ ìˆ˜', 'ê²½ìŸì •ë„', 'ì‚¬ìš©API', 'ìºì‹œ', 'ì—ëŸ¬'];
    const rows = [headers];
    
    allRows.forEach(row => {
        const pc = parseInt(row.monthlyPcQcCnt) || 0;
        const mo = parseInt(row.monthlyMobileQcCnt) || 0;
        const total = pc + mo;
        
        rows.push([
            row.keyword,
            total,
            pc,
            mo,
            row.monthlyAvePcClkCnt || '',
            row.monthlyAveMobileClkCnt || '',
            row.monthlyAvePcCtr || '',
            row.monthlyAveMobileCtr || '',
            row.plAvgDepth || '',
            row.compIdx || '',
            row.api_used || '',
            row.fromCache ? 'Y' : 'N',
            row.error || ''
        ]);
    });
    
    const csvContent = '\ufeff' + rows.map(row => 
        row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')
    ).join('\r\n');
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `naver_search_${new Date().toISOString().slice(0,10)}.csv`;
    link.click();
}

// Excel ë‹¤ìš´ë¡œë“œ
function downloadExcel() {
    if (allRows.length === 0) return;
    
    const wsData = [
        ['í‚¤ì›Œë“œ', 'ì´ê²€ìƒ‰ìˆ˜', 'PCê²€ìƒ‰ìˆ˜', 'ëª¨ë°”ì¼ê²€ìƒ‰ìˆ˜', 'PCí´ë¦­ìˆ˜', 'ëª¨ë°”ì¼í´ë¦­ìˆ˜',
         'PC_CTR', 'ëª¨ë°”ì¼_CTR', 'í‰ê· ë…¸ì¶œê´‘ê³ ìˆ˜', 'ê²½ìŸì •ë„', 'ì‚¬ìš©API', 'ìºì‹œ', 'ì—ëŸ¬']
    ];
    
    allRows.forEach(row => {
        const pc = parseInt(row.monthlyPcQcCnt) || 0;
        const mo = parseInt(row.monthlyMobileQcCnt) || 0;
        const total = pc + mo;
        
        wsData.push([
            row.keyword,
            total,
            pc,
            mo,
            row.monthlyAvePcClkCnt || '',
            row.monthlyAveMobileClkCnt || '',
            row.monthlyAvePcCtr || '',
            row.monthlyAveMobileCtr || '',
            row.plAvgDepth || '',
            row.compIdx || '',
            row.api_used || '',
            row.fromCache ? 'Y' : 'N',
            row.error || ''
        ]);
    });
    
    const ws = XLSX.utils.aoa_to_sheet(wsData);
    
    // ì—´ ë„ˆë¹„ ìë™ ì¡°ì •
    const colWidths = wsData[0].map((_, colIndex) => ({
        wch: Math.max(...wsData.map(row => 
            String(row[colIndex] || '').length
        )) + 2
    }));
    ws['!cols'] = colWidths;
    
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'ê²€ìƒ‰ëŸ‰ ë°ì´í„°');
    
    XLSX.writeFile(wb, `naver_search_${new Date().toISOString().slice(0,10)}.xlsx`);
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
window.addEventListener('DOMContentLoaded', init);

// ì‹œê°„ëŒ€ë³„ íŠ¹ë³„ ë©”ì‹œì§€
window.addEventListener('DOMContentLoaded', () => {
    const now = new Date();
    const hour = now.getHours();
    const timeMessage = document.getElementById('timeMessage');
    const timeMessageTitle = document.getElementById('timeMessageTitle');
    const timeMessageText = document.getElementById('timeMessageText');
    
    if ((hour === 18 && now.getMinutes() >= 50) || hour >= 19 || hour < 4) {
        timeMessageTitle.innerHTML = '<span style="font-size: 1.3em; display: block; margin-bottom: 8px;">ğŸŒ™</span>ì•¼ê·¼ ì•Œë¦¼';
        timeMessageText.innerHTML = 'ì•¼ê·¼í•˜ì‹œë‚˜ìš”?<br>ê±´ê°• ì¡°ì‹¬í•˜ì„¸ìš”!<br>ìŠ¤íŠ¸ë ˆì¹­í•˜ê³ <br>ëˆˆë„ ì‰¬ì–´ì£¼ì„¸ìš”.';
        timeMessage.classList.add('active');
    } else if (hour === 12) {
        timeMessageTitle.innerHTML = '<span style="font-size: 1.3em; display: block; margin-bottom: 8px;">ğŸœ</span>ì ì‹¬ì‹œê°„';
        timeMessageText.innerHTML = 'ê³§ ì ì‹¬ì‹œê°„ì´ë„¤ìš”!<br>ë§›ìˆëŠ” ê±° ë“œì„¸ìš”!<br>ì˜¤í›„ë„ í™”ì´íŒ…!';
        timeMessage.classList.add('active');
    }
});

</script>

<!-- ì‹œê°„ëŒ€ë³„ ë©”ì‹œì§€ -->
<div class="time-message" id="timeMessage">
    <button class="close-btn" onclick="document.getElementById('timeMessage').classList.remove('active')">Ã—</button>
    <h3 id="timeMessageTitle"></h3>
    <p id="timeMessageText"></p>
</div>
</body>
</html>